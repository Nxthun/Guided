<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guided Flashcards</title>
    
    <!-- Babel Standalone for in-browser JSX/TS transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Markdown and Sanitizer Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>

    <style>
      :root {
        --bg-gradient: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        --text-color: #1f2937;
        --text-color-light: #6b7280;
        --glass-bg: rgba(255, 255, 255, 0.2);
        --glass-border: rgba(255, 255, 255, 0.3);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --accent-color: #8b5cf6;
      }
      :root[data-theme='dark'] {
        --bg-gradient: #000000;
        --text-color: #f9fafb;
        --text-color-light: #9ca3af;
        --glass-bg: rgba(31, 41, 55, 0.2);
        --glass-border: rgba(255, 255, 255, 0.1);
        --shadow-color: rgba(0, 0, 0, 0.2);
        --accent-color: #a78bfa;
      }
      :root[data-theme='kirby'] {
        --bg-gradient: linear-gradient(120deg, #ffc0cb 0%, #87ceeb 100%);
        --text-color: #1e244d;
        --text-color-light: #4a517e;
        --glass-bg: rgba(255, 255, 255, 0.3);
        --glass-border: rgba(255, 255, 255, 0.4);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --accent-color: #e879f9;
      }
      :root[data-theme='forest'] {
        --bg-gradient: linear-gradient(120deg, #2d5a2d 0%, #0e2a0e 100%);
        --text-color: #f0fff0;
        --text-color-light: #a8d5a8;
        --glass-bg: rgba(45, 90, 45, 0.2);
        --glass-border: rgba(240, 255, 240, 0.2);
        --shadow-color: rgba(0, 0, 0, 0.25);
        --accent-color: #86efac;
      }
      body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-gradient);
        color: var(--text-color);
        transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
      }
      .glass-card {
        background-color: var(--glass-bg);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 var(--shadow-color);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        background-image: radial-gradient(circle at 0% 0%, rgba(255, 255, 255, 0.1), transparent 40%);
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
      }
      .glass-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px 0 var(--shadow-color);
      }
      .card-flip-container {
        perspective: 1000px;
      }
      .card-flipper {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
      }
      .card-flipper.is-flipped {
        transform: rotateY(180deg);
      }
      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card-back {
        transform: rotateY(180deg);
      }
      /* Drag and Drop Styles */
      .dragging {
        opacity: 0.5;
        transform: scale(1.05);
      }
      .drag-placeholder {
        background-color: rgba(255, 255, 255, 0.2);
        border: 2px dashed var(--glass-border);
        border-radius: 1rem; /* same as cards */
      }
      /* Custom Slider Styles */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        background: var(--glass-bg);
        border-radius: 5px;
        border: 1px solid var(--glass-border);
        outline: none;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        border: 2px solid var(--accent-color);
        cursor: pointer;
        margin-top: -8px; /* Offset to center thumb on track */
        box-shadow: 0 0 5px var(--accent-color);
        transition: transform 0.1s ease-in-out;
      }
       input[type="range"]::-webkit-slider-thumb:active {
        transform: scale(1.2);
      }
      input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        border: 2px solid var(--accent-color);
        cursor: pointer;
        box-shadow: 0 0 5px var(--accent-color);
        transition: transform 0.1s ease-in-out;
      }
      input[type="range"]::-moz-range-thumb:active {
        transform: scale(1.2);
      }
      /* Title Animation */
      @keyframes bounce-in {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
      }
      .title-char {
        display: inline-block;
        animation: bounce-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        opacity: 0;
        white-space: pre; 
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.81.1"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { createClient } from '@supabase/supabase-js';

      // --- From services/supabaseClient.ts ---
      const supabaseUrl = 'https://jccslseigqjercgoqocb.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjY3Nsc2VpZ3FqZXJjZ29xb2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODIxNTcsImV4cCI6MjA3ODY1ODE1N30.HuepsMd_fMgJdvX7usXHDTKqRdMrqsuDuML0ZcL4FPs';
      const supabase = createClient(supabaseUrl, supabaseAnonKey);
      
      // --- Helper Functions (hoisted from App.tsx) ---
      const renderMarkdown = (markdown) => {
          if (!markdown) return { __html: '' };
          const dirty = window.marked.parse(markdown);
          const clean = window.DOMPurify.sanitize(dirty);
          return { __html: clean };
      };

      const fileToDataUrl = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      };

      // --- From components/Icon.tsx ---
      const Icon = ({ name, className = 'w-6 h-6' }) => {
        const icons = {
          folder: <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>,
          deck: <><path d="M20 10c0-2-2-4-4-4H8c-2.2 0-4 1.8-4 4s1.8 4 4 4h8c2 0 4-2 4-4Z"></path><path d="M4 14c0 2.2 1.8 4 4 4h8c2 0 4-2 4-4"></path><path d="M4 6c0-2.2 1.8-4 4-4h8c2 0 4 2 4 4"></path></>,
          card: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" x2="21" y1="9" y2="9"></line></>,
          plus: <><path d="M5 12h14"></path><path d="M12 5v14"></path></>,
          trash: <><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></>,
          edit: <><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></>,
          close: <><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></>,
          settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2Z"></path><circle cx="12" cy="12" r="3"></circle></>,
          logout: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></>,
          back: <path d="m15 18-6-6 6-6"></path>,
          study: <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v16H6.5a2.5 2.5 0 0 1 0-5H20"></path>,
          import: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></>,
          export: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></>,
          next: <path d="m9 18 6-6-6-6"></path>,
          prev: <path d="m15 18-6-6 6-6"></path>,
          shuffle: <><path d="M2 18h1.4c1.3 0 2.5-.6 3.4-1.6l1.8-2.1c.9-1 2.2-1.6 3.5-1.6h3.8c1.3 0 2.5-.6 3.4-1.6l1.8-2.1c.9-1 2.2-1.6 3.5-1.6H22"></path><path d="m18 2 4 4-4 4"></path><path d="M2 6h1.4c1.3 0 2.5.6 3.4 1.6l1.8 2.1c.9 1 2.2 1.6 3.5 1.6h3.8c1.3 0 2.5.6 3.4 1.6l1.8 2.1c.9 1 2.2 1.6 3.5 1.6H22"></path><path d="m18 22-4-4 4-4"></path></>,
          search: <><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></>,
          check: <path d="M20 6 9 17l-5-5"></path>,
          copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></>,
          'grip-vertical': <><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></>,
          image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></>,
          'layout-grid': <><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></>,
          'list': <><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></>,
          'chevron-down': <path d="m6 9 6 6 6-6"></path>,
          'minus': <path d="M5 12h14"></path>,
          'refresh-ccw': <><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></>,
          'chevrons-up-down': <><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></>
        };

        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={className}
          >
            {icons[name]}
          </svg>
        );
      };

      // --- From components/Modal.tsx ---
      const Modal = ({ isOpen, onClose, title, children }) => {
        const [show, setShow] = React.useState(false);

        useEffect(() => {
          if (isOpen) {
            setShow(true);
          } else {
            // Allow fade-out animation
            const timer = setTimeout(() => setShow(false), 300);
            return () => clearTimeout(timer);
          }
        }, [isOpen]);

        useEffect(() => {
          const handleEsc = (event) => {
            if (event.key === 'Escape') {
              onClose();
            }
          };
          window.addEventListener('keydown', handleEsc);
          return () => {
            window.removeEventListener('keydown', handleEsc);
          };
        }, [onClose]);

        if (!show) return null;

        return (
          <div
            className={`fixed inset-0 z-50 flex items-center justify-center bg-black/50 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0'}`}
            onClick={onClose}
          >
            <div
              className={`glass-card rounded-2xl w-full max-w-md m-4 p-6 text-[--text-color] transform transition-all duration-300 ${isOpen ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">{title}</h2>
                <button
                  onClick={onClose}
                  className="p-2 rounded-full hover:bg-white/20 transition-colors"
                  aria-label="Close modal"
                >
                  <Icon name="close" className="w-6 h-6" />
                </button>
              </div>
              <div>{children}</div>
            </div>
          </div>
        );
      };
      
      // --- From components/Dropdown.tsx ---
      const Dropdown = ({ options, value, onChange, className = '', variant = 'default' }) => {
        const [isOpen, setIsOpen] = useState(false);
        const dropdownRef = useRef(null);
        const selectedOption = options.find(option => option.value === value);

        useEffect(() => {
          const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
              setIsOpen(false);
            }
          };
          const handleEsc = (event) => {
            if (event.key === 'Escape') {
              setIsOpen(false);
            }
          };
          
          document.addEventListener('mousedown', handleClickOutside);
          window.addEventListener('keydown', handleEsc);

          return () => {
              document.removeEventListener('mousedown', handleClickOutside);
              window.removeEventListener('keydown', handleEsc);
          }
        }, []);

        const handleSelect = (optionValue) => {
          onChange(optionValue);
          setIsOpen(false);
        };
        
        const triggerBaseClasses = "w-full flex items-center justify-between text-[--text-color] focus:ring-2 focus:ring-[--accent-color] focus:outline-none transition-all duration-200";
        const variantTriggerClasses = {
          default: "bg-white/10 border border-white/20 rounded-full py-2 px-4 font-medium",
          compact: "bg-transparent text-sm font-bold px-1"
        };

        const dropdownPanelClasses = variant === 'compact' ? 'w-28 right-0' : 'w-full';

        return (
          <div className={`relative ${className}`} ref={dropdownRef}>
            <button
              type="button"
              onClick={() => setIsOpen(!isOpen)}
              className={`${triggerBaseClasses} ${variantTriggerClasses[variant]}`}
              aria-haspopup="listbox"
              aria-expanded={isOpen}
            >
              <span>{selectedOption?.label}</span>
              <Icon name="chevron-down" className={`w-5 h-5 transition-transform text-[--text-color-light] ${isOpen ? 'rotate-180' : ''}`} />
            </button>

            <div className={`absolute z-20 top-full mt-2 glass-card rounded-xl p-1.5 shadow-lg transition-all duration-200 ease-out origin-top ${dropdownPanelClasses} ${isOpen ? 'opacity-100 scale-100' : 'opacity-0 scale-95 pointer-events-none'}`}>
                <ul className="space-y-1" role="listbox">
                  {options.map(option => (
                    <li key={option.value} role="option" aria-selected={value === option.value}>
                      <button
                        type="button"
                        onClick={() => handleSelect(option.value)}
                        className={`w-full text-left p-2 rounded-md hover:bg-white/20 transition-colors flex justify-between items-center text-sm font-medium ${value === option.value ? 'text-[--accent-color]' : 'text-[--text-color]'}`}
                      >
                        {option.label}
                        {value === option.value && <Icon name="check" className="w-4 h-4" />}
                      </button>
                    </li>
                  ))}
                </ul>
            </div>
          </div>
        );
      };

      // --- From components/StudyModal.tsx ---
      const StudyModal = ({ isOpen, onClose, deckName, cards: initialCards }) => {
        const [show, setShow] = useState(false);
        const [isFlipped, setIsFlipped] = useState(false);
        
        const [unseenCards, setUnseenCards] = useState([]);
        const [learningCards, setLearningCards] = useState([]);
        const [completedCards, setCompletedCards] = useState([]);
        const [currentCard, setCurrentCard] = useState(null);
        const [isSessionComplete, setIsSessionComplete] = useState(false);
        
        const shuffle = (array) => [...array].sort(() => Math.random() - 0.5);

        const startSession = useCallback((shouldShuffle = true) => {
          const cardsToStudy = shouldShuffle ? shuffle(initialCards) : initialCards;
          
          if (cardsToStudy.length > 0) {
            setCurrentCard(cardsToStudy[0]);
            setUnseenCards(cardsToStudy.slice(1));
          } else {
            setCurrentCard(null);
            setUnseenCards([]);
          }
          
          setLearningCards([]);
          setCompletedCards([]);
          setIsFlipped(false);
          setIsSessionComplete(false);
        }, [initialCards]);

        useEffect(() => {
          if (isOpen) {
            setShow(true);
            startSession();
          } else {
            const timer = setTimeout(() => setShow(false), 300);
            return () => clearTimeout(timer);
          }
        }, [isOpen, startSession]);
        
        const pickNextCard = useCallback((currentUnseen, currentLearning) => {
            setIsFlipped(false);
            
            setTimeout(() => {
                if (currentUnseen.length > 0) {
                    setCurrentCard(currentUnseen[0]);
                    setUnseenCards(currentUnseen.slice(1));
                } else if (currentLearning.length > 0) {
                    const shuffledLearning = shuffle(currentLearning);
                    setCurrentCard(shuffledLearning[0]);
                    setLearningCards(shuffledLearning.slice(1));
                } else {
                    setCurrentCard(null);
                    setIsSessionComplete(true);
                }
            }, 150);
        }, []);

        const handleRate = useCallback((rating) => {
            if (!currentCard) return;

            if (rating === 'again') {
                setLearningCards(prev => [...prev, currentCard]);
            } else {
                setCompletedCards(prev => [...prev, currentCard]);
            }
            
            pickNextCard(unseenCards, learningCards);
        }, [currentCard, unseenCards, learningCards, pickNextCard]);

        useEffect(() => {
          const handleKeyDown = (event) => {
            if (!isOpen || isSessionComplete || !currentCard) return;

            if (event.key === ' ') {
              event.preventDefault();
              setIsFlipped((f) => !f);
            }

            if (isFlipped) {
                if (event.key === '1') handleRate('again');
                if (event.key === '2') handleRate('good');
                if (event.key === '3') handleRate('easy');
            }

            if (event.key === 'Escape') onClose();
          };

          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [isOpen, isSessionComplete, currentCard, isFlipped, handleRate, onClose]);
        
        const CardFaceContent = ({ content, image }) => (
          <div className="glass-card rounded-2xl w-full h-full p-6 flex flex-col items-center justify-center overflow-y-auto">
              {image && (
                  <img src={image} alt="Card content" className="max-w-full max-h-48 object-contain rounded-lg mb-4"/>
              )}
              <div 
                  className="prose prose-xl text-[--text-color] text-center max-w-none" 
                  dangerouslySetInnerHTML={renderMarkdown(content)}
              ></div>
          </div>
        );

        const totalCards = initialCards.length;
        const remainingInQueue = unseenCards.length + learningCards.length;
        const progress = totalCards > 0 ? (completedCards.length / totalCards) * 100 : 0;
        
        if (!show) return null;

        const renderContent = () => {
          if (isSessionComplete) {
              return (
                  <div className="glass-card rounded-2xl w-full h-full p-6 flex flex-col items-center justify-center text-center">
                      <Icon name="check" className="w-20 h-20 text-green-400 mb-4" />
                      <h3 className="text-3xl font-bold text-[--text-color]">Deck Complete!</h3>
                      <p className="text-[--text-color-light] mb-8">You've finished this study session.</p>
                      <div className="flex gap-4">
                          <button onClick={() => startSession()} className="bg-[--glass-bg] border border-[--glass-border] shadow-lg py-3 px-6 rounded-full hover:scale-105 active:scale-100 transition-transform flex items-center gap-2 text-[--text-color] font-semibold">
                              <Icon name="refresh-ccw" className="w-5 h-5" />
                              Study Again
                          </button>
                          <button onClick={onClose} className="bg-[--accent-color]/80 text-white shadow-lg py-3 px-6 rounded-full hover:scale-105 active:scale-100 transition-transform font-semibold">
                              Finish
                          </button>
                      </div>
                  </div>
              );
          }
          
          if (!currentCard) {
              return (
                   <div className="glass-card rounded-2xl w-full h-full p-6 flex flex-col items-center justify-center text-center">
                      <Icon name="card" className="w-16 h-16 text-[--text-color-light] mb-4" />
                      <h3 className="text-2xl font-bold text-[--text-color]">This deck is empty.</h3>
                      <p className="text-[--text-color-light]">Add some cards to start studying!</p>
                  </div>
              )
          }

          return (
              <>
                  <div className="w-full h-full card-flip-container" onClick={() => setIsFlipped(!isFlipped)}>
                      <div className={`card-flipper ${isFlipped ? 'is-flipped' : ''}`}>
                          <div className="card-face card-front">
                              <CardFaceContent content={currentCard.front} image={currentCard.front_image_url} />
                          </div>
                          <div className="card-face card-back">
                              <CardFaceContent content={currentCard.back} image={currentCard.back_image_url} />
                          </div>
                      </div>
                  </div>
                  <div className={`absolute bottom-0 left-1/2 -translate-x-1/2 w-full max-w-sm flex justify-around items-center p-4 transition-all duration-300 ease-in-out ${isFlipped ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                      <button onClick={() => handleRate('again')} className="flex flex-col items-center gap-2 text-red-400 hover:scale-110 transition-transform font-semibold p-2">
                          <span className="py-2 px-6 rounded-full bg-red-400/20 border border-red-400/30">Again</span>
                          <span className="text-xs text-white/70">Press 1</span>
                      </button>
                       <button onClick={() => handleRate('good')} className="flex flex-col items-center gap-2 text-sky-400 hover:scale-110 transition-transform font-semibold p-2">
                          <span className="py-2 px-6 rounded-full bg-sky-400/20 border border-sky-400/30">Good</span>
                          <span className="text-xs text-white/70">Press 2</span>
                      </button>
                       <button onClick={() => handleRate('easy')} className="flex flex-col items-center gap-2 text-green-400 hover:scale-110 transition-transform font-semibold p-2">
                          <span className="py-2 px-6 rounded-full bg-green-400/20 border border-green-400/30">Easy</span>
                          <span className="text-xs text-white/70">Press 3</span>
                      </button>
                  </div>
              </>
          );
        }

        return (
          <div className={`fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/70 p-4 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0'}`}>
            <div className={`w-full max-w-3xl flex flex-col transition-all duration-300 ${isOpen ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}`}>
              <div className="flex justify-between items-center mb-2 px-2 text-white">
                <div className="text-left">
                  <h2 className="text-2xl font-bold">{deckName}</h2>
                   {totalCards > 0 && !isSessionComplete &&
                      <p className="text-lg opacity-80">
                          {remainingInQueue + (currentCard ? 1 : 0)} remaining
                          <span className="mx-2 text-white/50">|</span>
                          {learningCards.length} reviewing
                      </p>
                   }
                </div>
                <div className="flex items-center gap-2">
                  {totalCards > 0 &&
                      <button onClick={() => startSession()} className="p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Restart session">
                          <Icon name="refresh-ccw" className="w-6 h-6" />
                      </button>
                  }
                  <button onClick={onClose} className="p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Close study session">
                    <Icon name="close" className="w-8 h-8" />
                  </button>
                </div>
              </div>

              {totalCards > 0 &&
                  <div className="w-full h-2 bg-white/20 rounded-full my-2 overflow-hidden">
                      <div className="h-full bg-[var(--accent-color)] rounded-full transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div>
                  </div>
              }
              
              <div className="w-full h-[55vh] max-h-[500px] relative">
                  {renderContent()}
              </div>
            </div>
          </div>
        );
      };

      // --- From App.tsx ---
      function App() {
        const [session, setSession] = useState(null);
        const [folders, setFolders] = useState([]);
        const [view, setView] = useState('folders');
        const [activeFolder, setActiveFolder] = useState(null);
        const [activeDeck, setActiveDeck] = useState(null);
        const [activeTheme, setActiveTheme] = useState('light');
        const [customThemes, setCustomThemes] = useState([]);
        const [searchTerm, setSearchTerm] = useState('');
        const [sortOption, setSortOption] = useState('custom');
        const [loading, setLoading] = useState(true);
        const [isFirstLoad, setIsFirstLoad] = useState(false);

        const [cardViewMode, setCardViewMode] = useState('grid');
        const [cardGridSizeIndex, setCardGridSizeIndex] = useState(2);
        const [cardListDensityIndex, setCardListDensityIndex] = useState(1);

        const [modal, setModal] = useState({ type: null, data: undefined });
        const [studyModalOpen, setStudyModalOpen] = useState(false);
        
        const [draggedItem, setDraggedItem] = useState(null);

        const GRID_SIZE_STEPS = [140, 180, 240, 300, 360];
        const DEFAULT_GRID_SIZE_INDEX = 2;

        const LIST_DENSITY_OPTIONS = [
            { name: 'Spacious', padding: 'p-6', prose: 'prose-base' },
            { name: 'Comfortable', padding: 'p-4', prose: '' },
            { name: 'Compact', padding: 'p-2', prose: 'prose-sm' }
        ];
        const DEFAULT_LIST_DENSITY_INDEX = 1;
        
        useEffect(() => {
          const hasAnimatedBefore = sessionStorage.getItem('guided-title-animated');
          if (!hasAnimatedBefore) {
              setIsFirstLoad(true);
              sessionStorage.setItem('guided-title-animated', 'true');
          }

          supabase.auth.getSession().then(({ data: { session } }) => {
            setSession(session);
            setLoading(false);
          });

          const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            setSession(session);
          });

          return () => subscription.unsubscribe();
        }, []);

        const fetchData = useCallback(async () => {
          if (!session) return;
          setLoading(true);
          const { data, error } = await supabase
            .from('folders')
            .select('*, decks(*, cards(*))')
            .eq('user_id', session.user.id)
            .order('order', { ascending: true })
            .order('order', { foreignTable: 'decks', ascending: true })
            .order('order', { foreignTable: 'decks.cards', ascending: true });

          if (error) {
            console.error('Error fetching data:', error);
            alert('Could not fetch your data. Please try again.');
          } else {
            setFolders(data || []);
          }
          setLoading(false);
        }, [session]);

        useEffect(() => {
          if (window.marked) {
              window.marked.setOptions({
                  gfm: true,
                  breaks: true,
              });
          }
        }, []);

        useEffect(() => {
          if (session) {
            fetchData();
          } else {
            setFolders([]);
          }
        }, [session, fetchData]);
        
        const presetThemes = [
            { id: 'light', name: 'Default Light', class: 'bg-gradient-to-br from-gray-100 to-gray-200' },
            { id: 'dark', name: 'OLED Dark', class: 'bg-black' },
            { id: 'kirby', name: 'Kirby', class: 'bg-gradient-to-br from-pink-300 to-sky-400' },
            { id: 'forest', name: 'Forest', class: 'bg-gradient-to-br from-green-700 to-green-900' }
        ];

        useEffect(() => {
          const savedCustomThemes = localStorage.getItem('flashcard-custom-themes');
          const loadedCustomThemes = savedCustomThemes ? JSON.parse(savedCustomThemes) : [];
          if (savedCustomThemes) setCustomThemes(loadedCustomThemes);

          const savedThemeId = localStorage.getItem('flashcard-active-theme-id') || 'light';
          const customTheme = loadedCustomThemes.find(t => t.id === savedThemeId);
          if (customTheme) setActiveTheme(customTheme);
          else setActiveTheme((presetThemes.find(t => t.id === savedThemeId)?.id || 'light'));
          
          const savedViewMode = localStorage.getItem('flashcard-view-mode');
          if(savedViewMode) setCardViewMode(savedViewMode);

          const savedGridIndex = localStorage.getItem('flashcard-grid-size-index');
          if (savedGridIndex) setCardGridSizeIndex(parseInt(savedGridIndex, 10));

          const savedListDensityIndex = localStorage.getItem('flashcard-list-density-index');
          if (savedListDensityIndex) setCardListDensityIndex(parseInt(savedListDensityIndex, 10));

        }, []);

        useEffect(() => {
          if (typeof activeTheme === 'string') {
              document.documentElement.removeAttribute('style');
              document.documentElement.setAttribute('data-theme', activeTheme);
          } else {
              document.documentElement.removeAttribute('data-theme');
              const root = document.documentElement;
              const {colors} = activeTheme;
              root.style.setProperty('--bg-gradient', `linear-gradient(120deg, ${colors.bgGradientStart} 0%, ${colors.bgGradientEnd} 100%)`);
              root.style.setProperty('--text-color', colors.textColor);
              root.style.setProperty('--text-color-light', colors.textColorLight);
              root.style.setProperty('--glass-bg', colors.glassBg);
              root.style.setProperty('--glass-border', colors.glassBorder);
              root.style.setProperty('--shadow-color', colors.shadowColor);
              root.style.setProperty('--accent-color', colors.accentColor);
          }
           localStorage.setItem('flashcard-active-theme-id', typeof activeTheme === 'string' ? activeTheme : activeTheme.id);
        }, [activeTheme]);

        useEffect(() => {
            localStorage.setItem('flashcard-view-mode', cardViewMode);
        }, [cardViewMode]);

        useEffect(() => {
            localStorage.setItem('flashcard-grid-size-index', String(cardGridSizeIndex));
        }, [cardGridSizeIndex]);

        useEffect(() => {
            localStorage.setItem('flashcard-list-density-index', String(cardListDensityIndex));
        }, [cardListDensityIndex]);

        const navigateTo = (newView, data) => {
          setSearchTerm('');
          setSortOption('custom');
          if (newView === 'folders') {
            setActiveFolder(null);
            setActiveDeck(null);
          } else if (newView === 'decks' && data) {
            setActiveFolder(data);
            setActiveDeck(null);
          } else if (newView === 'cards' && data) {
            setActiveDeck(data);
          }
          setView(newView);
        };
        
        const handleAddEditFolder = async (name) => {
            if (!session) return;
            if(modal.type === 'addFolder') {
                const { data, error } = await supabase.from('folders').insert({ name, user_id: session.user.id, order: folders.length }).select().single();
                if (error) return alert(error.message);
                setFolders([...folders, { ...data, decks: []}]);
            } else if (modal.type === 'editFolder' && modal.data) {
                const { data, error } = await supabase.from('folders').update({ name }).eq('id', modal.data.id).select().single();
                if (error) return alert(error.message);
                setFolders(folders.map(f => f.id === modal.data.id ? {...f, name: data.name} : f));
            }
            setModal({ type: null });
        };

        const handleDeleteFolder = async (folderId) => {
            setFolders(folders.filter(f => f.id !== folderId)); // Optimistic update
            const { error } = await supabase.from('folders').delete().eq('id', folderId);
            if (error) {
                alert(error.message);
                fetchData(); // Revert on error
            }
            setModal({ type: null });
        };
        
        const handleAddEditDeck = async (name) => {
          if (!activeFolder || !session) return;
          if (modal.type === 'addDeck') {
              const { data, error } = await supabase.from('decks').insert({ name, folder_id: activeFolder.id, user_id: session.user.id, order: activeFolder.decks.length }).select().single();
              if (error) return alert(error.message);
              const newDeck = { ...data, cards: [] };
              const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: [...f.decks, newDeck] } : f);
              setFolders(updatedFolders);
              setActiveFolder(updatedFolders.find(f => f.id === activeFolder.id) || null);
          } else if (modal.type === 'editDeck' && modal.data) {
              const { data, error } = await supabase.from('decks').update({ name }).eq('id', modal.data.id).select().single();
              if (error) return alert(error.message);
              const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: f.decks.map(d => d.id === modal.data.id ? { ...d, name: data.name } : d) } : f);
              setFolders(updatedFolders);
              setActiveFolder(updatedFolders.find(f => f.id === activeFolder.id) || null);
          }
          setModal({ type: null });
        };

        const handleDeleteDeck = async (deckId) => {
            if (!activeFolder) return;
            const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: f.decks.filter(d => d.id !== deckId) } : f);
            setFolders(updatedFolders); // Optimistic update
            setActiveFolder(updatedFolders.find(f => f.id === activeFolder.id) || null);
            
            const { error } = await supabase.from('decks').delete().eq('id', deckId);
            if (error) {
                alert(error.message);
                fetchData(); // Revert on error
            }
            setModal({ type: null });
        };

        const uploadCardImage = async (file, cardId, side) => {
            if (!session) throw new Error("Not authenticated");
            const filePath = `${session.user.id}/${cardId}/${side}-${Date.now()}`;
            const { error: uploadError } = await supabase.storage.from('card-images').upload(filePath, file);
            if (uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage.from('card-images').getPublicUrl(filePath);
            return publicUrl;
        };

        const handleAddEditCard = async (front, back, frontImageFile, backImageFile, existingCard) => {
          if (!activeFolder || !activeDeck || !session) return;
          
          let front_image_url = existingCard?.front_image_url;
          let back_image_url = existingCard?.back_image_url;
          const cardId = existingCard?.id || `card-id-placeholder-${Date.now()}`;

          if (frontImageFile) front_image_url = await uploadCardImage(frontImageFile, cardId, 'front');
          if (backImageFile) back_image_url = await uploadCardImage(backImageFile, cardId, 'back');

          if (modal.type === 'addCard') {
            const { data, error } = await supabase.from('cards').insert({ 
              front, back, front_image_url, back_image_url, 
              deck_id: activeDeck.id, user_id: session.user.id, order: activeDeck.cards.length 
            }).select().single();
            if (error) return alert(error.message);

            const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: f.decks.map(d => d.id === activeDeck.id ? { ...d, cards: [...d.cards, data] } : d) } : f);
            setFolders(updatedFolders);
          } else if (modal.type === 'editCard' && existingCard) {
            const { data, error } = await supabase.from('cards').update({ front, back, front_image_url, back_image_url }).eq('id', existingCard.id).select().single();
            if (error) return alert(error.message);

            const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: f.decks.map(d => d.id === activeDeck.id ? { ...d, cards: d.cards.map(c => c.id === data.id ? data : c) } : d) } : f);
            setFolders(updatedFolders);
          }
          
          const newActiveFolder = folders.find(f => f.id === activeFolder.id) || null;
          setActiveFolder(newActiveFolder);
          setActiveDeck(newActiveFolder?.decks.find(d => d.id === activeDeck.id) || null);
          fetchData(); // refetch to get latest state
          setModal({ type: null });
        };
        
        const handleDeleteCard = async (cardId) => {
          if (!activeFolder || !activeDeck) return;
          const updatedCards = activeDeck.cards.filter(c => c.id !== cardId);
          const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: f.decks.map(d => d.id === activeDeck.id ? { ...d, cards: updatedCards } : d) } : f);
          setFolders(updatedFolders); // Optimistic

          const { error } = await supabase.from('cards').delete().eq('id', cardId);
          if (error) {
              alert(error.message);
              fetchData(); // Revert
          }

          const newActiveFolder = updatedFolders.find(f => f.id === activeFolder.id) || null;
          setActiveFolder(newActiveFolder);
          setActiveDeck(newActiveFolder?.decks.find(d => d.id === activeDeck.id) || null);
          setModal({ type: null });
        };
        
        const handleBulkAddCards = async (newCards, replace) => {
          if (!activeFolder || !activeDeck || !session) return;

          if (replace) {
            const { error: deleteError } = await supabase.from('cards').delete().eq('deck_id', activeDeck.id);
            if (deleteError) {
              alert(`Failed to delete old cards: ${deleteError.message}`);
              fetchData(); // Revert UI
              return;
            }
          }

          const currentCards = (replace ? [] : activeDeck.cards) || [];
          const cardsToInsert = newCards.map((card, index) => ({
            front: card.front,
            back: card.back,
            deck_id: activeDeck.id,
            user_id: session.user.id,
            order: currentCards.length + index,
          }));
          
          if (cardsToInsert.length === 0) {
              setModal({ type: null });
              return;
          }

          const { data: insertedCards, error: insertError } = await supabase.from('cards').insert(cardsToInsert).select();

          if (insertError) {
            alert(`Failed to import cards: ${insertError.message}`);
            fetchData(); // Revert
          } else if (insertedCards) {
            const allNewCards = [...currentCards, ...insertedCards];
            const updatedFolders = folders.map(f => f.id === activeFolder.id 
                ? { ...f, decks: f.decks.map(d => d.id === activeDeck.id ? { ...d, cards: allNewCards } : d) } 
                : f
            );
            setFolders(updatedFolders);
            const newActiveFolder = updatedFolders.find(f => f.id === activeFolder.id) || null;
            setActiveFolder(newActiveFolder);
            setActiveDeck(newActiveFolder?.decks.find(d => d.id === activeDeck.id) || null);
          }
          setModal({ type: null });
        };

        const handleExportDeck = () => {
          if (!activeDeck) return;

          const escapeCsvField = (field) => `"${String(field || '').replace(/"/g, '""')}"`;
          
          const csvContent = activeDeck.cards
            .sort((a, b) => a.order - b.order)
            .map(c => [escapeCsvField(c.front), escapeCsvField(c.back)].join(','))
            .join('\n');
          
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", `${activeDeck.name}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const handleCustomThemeSave = (theme) => {
          const existingIndex = customThemes.findIndex(t => t.id === theme.id);
          let updatedThemes;
          if (existingIndex > -1) updatedThemes = customThemes.map(t => t.id === theme.id ? theme : t);
          else updatedThemes = [...customThemes, theme];
          setCustomThemes(updatedThemes);
          localStorage.setItem('flashcard-custom-themes', JSON.stringify(updatedThemes));
          setActiveTheme(theme);
        };
        
        const handleCustomThemeDelete = (themeId) => {
            const updatedThemes = customThemes.filter(t => t.id !== themeId);
            setCustomThemes(updatedThemes);
            localStorage.setItem('flashcard-custom-themes', JSON.stringify(updatedThemes));
            if (typeof activeTheme !== 'string' && activeTheme.id === themeId) {
                setActiveTheme('light');
            }
        };

        const getSortFunction = (option) => {
          switch(option) {
              case 'name_asc': return (a, b) => a.name.localeCompare(b.name);
              case 'name_desc': return (a, b) => b.name.localeCompare(a.name);
              case 'date_asc': return (a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime();
              case 'date_desc': return (a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
              case 'custom':
              default: return (a, b) => a.order - b.order;
          }
        };

        const handleDragStart = (e, type, id) => {
            setDraggedItem({ type, id });
            e.dataTransfer.setData(`application/${type}-id`, id);
            e.currentTarget.classList.add('dragging');
        };
        
        const handleDragOver = (e) => e.preventDefault();
        
        const handleDrop = async (e, type, dropTargetId) => {
            e.preventDefault();
            if (!draggedItem || draggedItem.type !== type) return;

            const updateOrderInDb = async (tableName, items) => {
              const updates = items.map(item => ({ id: item.id, order: item.order }));
              const { error } = await supabase.from(tableName).upsert(updates);
              if (error) {
                  alert("Failed to save new order. Please refresh.");
                  fetchData(); // Revert UI on failure
              }
            };

            const reorderAndUpdateState = (items) => {
                let reordered = [...items];
                const startIndex = reordered.findIndex(item => item.id === draggedItem.id);
                const endIndex = reordered.findIndex(item => item.id === dropTargetId);
                if (startIndex === -1 || endIndex === -1 || startIndex === endIndex) return items;
                
                const [removed] = reordered.splice(startIndex, 1);
                reordered.splice(endIndex, 0, removed);
                return reordered.map((item, index) => ({ ...item, order: index }));
            };

            if (type === 'folder') {
                const reordered = reorderAndUpdateState(folders);
                setFolders(reordered);
                await updateOrderInDb('folders', reordered);
            } else if (type === 'deck' && activeFolder) {
                const reorderedDecks = reorderAndUpdateState(activeFolder.decks);
                const updatedFolders = folders.map(f => f.id === activeFolder.id ? { ...f, decks: reorderedDecks } : f);
                setFolders(updatedFolders);
                setActiveFolder(updatedFolders.find(f => f.id === activeFolder.id) || null);
                await updateOrderInDb('decks', reorderedDecks);
            } else if (type === 'card' && activeFolder && activeDeck) {
                const reorderedCards = reorderAndUpdateState(activeDeck.cards);
                const updatedFolders = folders.map(f => f.id === activeFolder.id ? {
                    ...f, decks: f.decks.map(d => d.id === activeDeck.id ? { ...d, cards: reorderedCards } : d)
                } : f);
                setFolders(updatedFolders);
                const newActiveFolder = updatedFolders.find(f => f.id === activeFolder.id) || null;
                setActiveFolder(newActiveFolder);
                setActiveDeck(newActiveFolder?.decks.find(d => d.id === activeDeck.id) || null);
                await updateOrderInDb('cards', reorderedCards);
            }
            setSortOption('custom');
        };
        
        const handleDragEnd = (e) => {
            e.currentTarget.classList.remove('dragging');
            setDraggedItem(null);
        };
        
        const AnimatedTitle = ({ text, className = '', animate = true }) => {
          if (!animate) {
            return <h1 className={className}>{text}</h1>;
          }
          return (
            <h1 className={className}>
              {text.split('').map((char, index) => (
                <span
                  key={index}
                  className="title-char"
                  style={{ animationDelay: `${index * 0.05}s` }}
                >
                  {char}
                </span>
              ))}
            </h1>
          );
        };

        const CuteButton = ({ children, className, as: Component = 'button', ...props }) => (
          <Component {...props} className={`bg-gradient-to-br from-white/40 to-white/20 border border-white/30 shadow-md text-[--text-color] font-bold py-2 px-5 rounded-xl transition-transform duration-150 ease-out hover:scale-105 active:scale-95 disabled:opacity-50 disabled:hover:scale-100 ${className || ''}`}>
              {children}
          </Component>
        );

        const FormInput = ({ id, label, ...props}) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-[--text-color-light] mb-1">{label}</label>
                <input id={id} {...props} className="w-full bg-white/20 border border-white/30 rounded-lg p-2 text-[--text-color] focus:ring-2 focus:ring-[--accent-color] focus:outline-none"/>
            </div>
        );
        
        const AuthScreen = () => {
          const [isSignUp, setIsSignUp] = useState(false);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [authLoading, setAuthLoading] = useState(false);
          const [message, setMessage] = useState('');

          const handleAuth = async (e) => {
              e.preventDefault();
              setAuthLoading(true);
              setMessage('');
              const { error } = isSignUp
                  ? await supabase.auth.signUp({ email, password })
                  : await supabase.auth.signInWithPassword({ email, password });
              
              if (error) setMessage(error.message);
              else if (isSignUp) setMessage('Success! Please check your email to verify your account.');
              setAuthLoading(false);
          };

          return (
              <div className="min-h-screen flex items-center justify-center p-4">
                  <div className="w-full max-w-md">
                      <div className="glass-card rounded-2xl p-8">
                          <AnimatedTitle text="Guided" className="text-4xl font-bold mb-2 text-center" />
                          <p className="text-[--text-color-light] mb-8 text-center">{isSignUp ? 'Create a new account.' : 'Welcome back.'}</p>
                          <form onSubmit={handleAuth}>
                              <FormInput id="email" label="Email" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                              <FormInput id="password" label="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                              <CuteButton type="submit" disabled={authLoading} className="w-full text-lg py-3">
                                  {authLoading ? 'Processing...' : isSignUp ? 'Sign Up' : 'Sign In'}
                              </CuteButton>
                          </form>
                          {message && <p className="mt-4 text-center text-sm text-[--accent-color]">{message}</p>}
                          <p className="mt-6 text-center text-sm">
                              {isSignUp ? 'Already have an account?' : "Don't have an account?"}
                              <button onClick={() => { setIsSignUp(!isSignUp); setMessage(''); }} className="font-bold text-[--accent-color] hover:underline ml-1">
                                  {isSignUp ? 'Sign In' : 'Sign Up'}
                              </button>
                          </p>
                      </div>
                  </div>
              </div>
          );
        };
        
        const Header = () => (
            <header className="p-4 flex justify-between items-center w-full max-w-7xl mx-auto">
                <div className="flex items-center gap-2">
                  <Icon name="study" className="w-8 h-8"/>
                  <AnimatedTitle text="Guided" className="text-2xl font-bold" animate={isFirstLoad} />
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => setModal({ type: 'settings' })} className="p-3 rounded-full hover:bg-white/20 transition-colors">
                    <Icon name="settings" className="w-6 h-6"/>
                  </button>
                  <button onClick={() => supabase.auth.signOut()} className="p-3 rounded-full hover:bg-white/20 transition-colors">
                    <Icon name="logout" className="w-6 h-6"/>
                  </button>
                </div>
            </header>
        );

        const Breadcrumbs = () => (
          <div className="flex items-center gap-2 text-xl font-semibold text-[--text-color-light] mb-4">
              <button onClick={() => navigateTo('folders')} className="hover:text-[--text-color]">Folders</button>
              {activeFolder && <span className="text-2xl">/</span>}
              {activeFolder && <button onClick={() => navigateTo('decks', activeFolder)} className={`hover:text-[--text-color] ${!activeDeck ? 'text-[--text-color]' : ''}`}>{activeFolder.name}</button>}
              {activeDeck && <span className="text-2xl">/</span>}
              {activeDeck && <span className="text-[--text-color]">{activeDeck.name}</span>}
          </div>
        );
        
        const sortAndFilter = (items) => {
          if (!items) return [];
          const sorted = [...items].sort(getSortFunction(sortOption));
          return sorted.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
        };
        
        const filteredFolders = sortAndFilter(folders);
        const filteredDecks = sortAndFilter(activeFolder?.decks);
        const filteredCards = useMemo(() => {
          if (!activeDeck?.cards) return [];
          let cardsToFilter = [...activeDeck.cards];
          
          switch(sortOption) {
              case 'name_asc': cardsToFilter.sort((a, b) => a.front.localeCompare(b.front)); break;
              case 'name_desc': cardsToFilter.sort((a, b) => b.front.localeCompare(a.front)); break;
              case 'date_asc': cardsToFilter.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime()); break;
              case 'date_desc': cardsToFilter.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()); break;
              case 'custom':
              default: cardsToFilter.sort((a, b) => a.order - b.order); break;
          }

          if(!searchTerm) return cardsToFilter;
          return cardsToFilter.filter(card => 
            card.front.toLowerCase().includes(searchTerm.toLowerCase()) || 
            card.back.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }, [activeDeck?.cards, sortOption, searchTerm]);
        
        const AddEditCardForm = () => {
          const [frontImage, setFrontImage] = useState({ url: modal.data?.front_image_url });
          const [backImage, setBackImage] = useState({ url: modal.data?.back_image_url });
          const [isSubmitting, setIsSubmitting] = useState(false);

          const handleFileChange = async (e, setter) => {
              const file = e.target.files?.[0];
              if (file) {
                  const dataUrl = await fileToDataUrl(file);
                  setter({ file, url: dataUrl });
              }
          };

          const handleSubmit = async (e) => {
              e.preventDefault();
              setIsSubmitting(true);
              const form = e.currentTarget;
              await handleAddEditCard(form.front.value, form.back.value, frontImage.file, backImage.file, modal.data);
              setIsSubmitting(false);
          };

          const FileInput = ({ id, label, onChange, previewUrl, onClear }) => (
              <div className="mb-4">
                  <label htmlFor={id} className="block text-sm font-medium text-[--text-color-light] mb-1">{label}</label>
                  {previewUrl ? (
                      <div className="flex items-center gap-2">
                          <img src={previewUrl} className="h-16 w-16 object-contain rounded-md bg-white/10 p-1" />
                          <button type="button" onClick={onClear} className="p-2 rounded-full hover:bg-white/20"> <Icon name="trash" className="w-5 h-5 text-red-400" /> </button>
                      </div>
                  ) : (
                      <label className="w-full flex items-center justify-center px-4 py-2 bg-white/20 border border-white/30 rounded-lg cursor-pointer hover:bg-white/30">
                          <Icon name="image" className="w-5 h-5 mr-2 text-[--text-color-light]" />
                          <span className="text-sm text-[--text-color-light]">Upload Image</span>
                          <input id={id} type="file" accept="image/*" className="hidden" onChange={onChange} />
                      </label>
                  )}
              </div>
          );
          const FormTextArea = ({ id, label, ...props}) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-[--text-color-light] mb-1">{label}</label>
                <textarea id={id} {...props} rows={3} className="w-full bg-white/20 border border-white/30 rounded-lg p-2 text-[--text-color] focus:ring-2 focus:ring-[--accent-color] focus:outline-none"/>
            </div>
          );

          return (
              <form onSubmit={handleSubmit}>
                  <FormTextArea id="front" label="Front" name="front" defaultValue={modal.data?.front || ''} required autoFocus/>
                  <FileInput id="frontImage" label="Front Image (Optional)" onChange={(e) => handleFileChange(e, setFrontImage)} previewUrl={frontImage.url} onClear={() => setFrontImage({})} />
                  <FormTextArea id="back" label="Back" name="back" defaultValue={modal.data?.back || ''} required/>
                  <FileInput id="backImage" label="Back Image (Optional)" onChange={(e) => handleFileChange(e, setBackImage)} previewUrl={backImage.url} onClear={() => setBackImage({})} />
                  <CuteButton type="submit" disabled={isSubmitting} className="w-full py-3 mt-2">{isSubmitting ? 'Saving...' : modal.type === 'editCard' ? 'Save Changes' : 'Create Card'}</CuteButton>
              </form>
          );
        };
        
        const ImportCardsForm = ({ onImport }) => {
          const [fileContent, setFileContent] = useState('');
          const [delimiter, setDelimiter] = useState(',');
          const [replace, setReplace] = useState(false);
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [error, setError] = useState('');

          const parsedCards = useMemo(() => {
              if (!fileContent) return [];
              try {
                  setError('');
                  return fileContent
                      .split('\n')
                      .map(line => line.trim())
                      .filter(line => line)
                      .map(line => {
                          const parts = line.split(delimiter);
                          const front = parts[0]?.trim() || '';
                          const back = parts[1]?.trim() || '';
                          if (!front && !back) return null;
                          return { front, back };
                      })
                      .filter((card) => card !== null);
              } catch (e) {
                  setError('Failed to parse file. Please check the format and delimiter.');
                  return [];
              }
          }, [fileContent, delimiter]);

          const handleFileChange = (e) => {
              const file = e.target.files?.[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      setFileContent(event.target?.result);
                      setError('');
                  };
                  reader.onerror = () => setError('Could not read the file.');
                  reader.readAsText(file);
              }
          };

          const handleSubmit = async (e) => {
              e.preventDefault();
              if (parsedCards.length === 0) {
                  setError('No valid cards found to import. Please check your file.');
                  return;
              }
              setIsSubmitting(true);
              setError('');
              await onImport(parsedCards, replace);
              setIsSubmitting(false);
          };

          return (
              <form onSubmit={handleSubmit}>
                  <p className="text-sm text-[--text-color-light] mb-4">
                      Upload a CSV or TSV file. The first column will be the card front, and the second column will be the card back. Headers are not required.
                  </p>

                  <label className="w-full flex flex-col items-center justify-center px-4 py-6 bg-white/20 border-2 border-dashed border-white/30 rounded-lg cursor-pointer hover:bg-white/30 transition-colors">
                      <Icon name="import" className="w-8 h-8 mb-2 text-[--text-color-light]" />
                      <span className="text-base font-semibold text-[--text-color]">
                          {fileContent ? `${parsedCards.length} cards found` : 'Choose a file or drag it here'}
                      </span>
                      <span className="text-xs text-[--text-color-light]">.csv, .tsv, .txt</span>
                      <input type="file" accept=".csv,.tsv,.txt" onChange={handleFileChange} className="hidden" />
                  </label>

                  <div className="my-4">
                      <label className="block text-sm font-medium text-[--text-color-light] mb-2">Delimiter</label>
                      <div className="flex gap-4 p-1 rounded-full glass-card w-min">
                          <button type="button" onClick={() => setDelimiter(',')} className={`px-4 py-1 rounded-full text-sm font-semibold transition-colors ${delimiter === ',' ? 'bg-white/30' : 'hover:bg-white/10'}`}>Comma</button>
                          <button type="button" onClick={() => setDelimiter('\t')} className={`px-4 py-1 rounded-full text-sm font-semibold transition-colors ${delimiter === '\t' ? 'bg-white/30' : 'hover:bg-white/10'}`}>Tab</button>
                      </div>
                  </div>

                  <div className="flex items-center gap-2 mb-4">
                      <input type="checkbox" id="replace-cards" checked={replace} onChange={e => setReplace(e.target.checked)} className="h-4 w-4 rounded accent-[--accent-color] bg-white/20 border-white/30 focus:ring-[--accent-color]" />
                      <label htmlFor="replace-cards" className="text-sm font-medium text-[--text-color]">Replace all existing cards in this deck</label>
                  </div>

                  {parsedCards.length > 0 && (
                      <div className="mt-4">
                          <h4 className="font-bold text-sm text-[--text-color-light] mb-2">PREVIEW</h4>
                          <div className="max-h-32 overflow-y-auto bg-white/10 rounded-lg p-2 text-sm">
                              <table className="w-full text-left">
                                  <tbody>
                                      {parsedCards.slice(0, 5).map((card, i) => (
                                          <tr key={i} className="border-b border-white/10">
                                              <td className="p-2 truncate" title={card.front}>{card.front}</td>
                                              <td className="p-2 text-[--text-color-light] truncate" title={card.back}>{card.back}</td>
                                          </tr>
                                      ))}
                                  </tbody>
                              </table>
                              {parsedCards.length > 5 && <p className="text-center text-xs p-2 text-[--text-color-light]">...and {parsedCards.length - 5} more cards.</p>}
                          </div>
                      </div>
                  )}
                  
                  {error && <p className="text-red-400 text-sm text-center mt-4">{error}</p>}

                  <CuteButton type="submit" disabled={isSubmitting || parsedCards.length === 0} className="w-full py-3 mt-4">
                      {isSubmitting ? 'Importing...' : `Import ${parsedCards.length} Cards`}
                  </CuteButton>
              </form>
          );
        };

         const renderContent = () => {
          if (loading && !folders.length) {
            return <div className="text-center p-10">Loading your study space...</div>
          }
          switch(view) {
              case 'decks': return (
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                      {filteredDecks.map(deck => (
                          <div key={deck.id} className="group relative" draggable onDragStart={(e) => handleDragStart(e, 'deck', deck.id)} onDrop={(e) => handleDrop(e, 'deck', deck.id)} onDragOver={handleDragOver} onDragEnd={handleDragEnd}>
                              <div className="glass-card rounded-2xl p-6 h-48 flex flex-col justify-between cursor-pointer transition-transform hover:scale-105" onClick={() => navigateTo('cards', deck)}>
                                  <Icon name="deck" className="w-10 h-10"/>
                                  <h3 className="text-xl font-bold mt-auto truncate">{deck.name}</h3>
                                  <p className="text-[--text-color-light]">{deck.cards.length} cards</p>
                              </div>
                              <div className="absolute top-2 right-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                  <Icon name="grip-vertical" className="w-5 h-5 cursor-move text-[--text-color-light]" />
                                  <button onClick={() => setModal({ type: 'editDeck', data: deck })} className="p-2 bg-white/20 rounded-full hover:bg-white/40"><Icon name="edit" className="w-4 h-4"/></button>
                                  <button onClick={() => setModal({ type: 'deleteDeck', data: deck })} className="p-2 bg-white/20 rounded-full hover:bg-white/40"><Icon name="trash" className="w-4 h-4"/></button>
                              </div>
                          </div>
                      ))}
                      <button onClick={() => setModal({ type: 'addDeck' })} className="border-2 border-dashed border-[--text-color-light]/50 rounded-2xl flex flex-col items-center justify-center h-48 hover:border-[--text-color] hover:text-[--text-color] text-[--text-color-light] transition-all duration-300 hover:bg-white/10">
                          <Icon name="plus" className="w-10 h-10"/>
                          <span className="mt-2 font-semibold">New Deck</span>
                      </button>
                  </div>
              );
              case 'cards':
                  return (
                  <>
                      <div className="flex justify-between items-center flex-wrap gap-4 mb-6">
                          <div className="flex flex-wrap gap-4">
                            <CuteButton onClick={() => setStudyModalOpen(true)}><Icon name="study" className="w-5 h-5 inline mr-2"/>Study Deck</CuteButton>
                            <CuteButton onClick={() => setModal({ type: 'importCards' })}><Icon name="import" className="w-5 h-5 inline mr-2"/>Import</CuteButton>
                            <CuteButton onClick={handleExportDeck}><Icon name="export" className="w-5 h-5 inline mr-2"/>Export</CuteButton>
                          </div>
                          <div className="flex items-center gap-1 p-1 rounded-full glass-card">
                              <button onClick={() => setCardViewMode('grid')} className={`p-2 rounded-full transition-colors ${cardViewMode === 'grid' ? 'bg-white/30' : 'hover:bg-white/10'}`}><Icon name="layout-grid" className="w-5 h-5" /></button>
                              <button onClick={() => setCardViewMode('list')} className={`p-2 rounded-full transition-colors ${cardViewMode === 'list' ? 'bg-white/30' : 'hover:bg-white/10'}`}><Icon name="list" className="w-5 h-5" /></button>
                              {cardViewMode === 'grid' && (
                                  <div className="flex items-center gap-2 ml-2">
                                      <button
                                          onClick={() => setCardGridSizeIndex(i => Math.max(0, i - 1))}
                                          disabled={cardGridSizeIndex === 0}
                                          className="p-1.5 rounded-full hover:bg-white/20 disabled:opacity-50 disabled:hover:bg-transparent"
                                      >
                                          <Icon name="minus" className="w-4 h-4 text-[--text-color-light]" />
                                      </button>
                                      <button onClick={() => setCardGridSizeIndex(DEFAULT_GRID_SIZE_INDEX)} className="p-1.5 rounded-full hover:bg-white/20">
                                          <Icon name="refresh-ccw" className="w-4 h-4 text-[--text-color-light]" />
                                      </button>
                                       <button
                                          onClick={() => setCardGridSizeIndex(i => Math.min(GRID_SIZE_STEPS.length - 1, i + 1))}
                                          disabled={cardGridSizeIndex === GRID_SIZE_STEPS.length - 1}
                                          className="p-1.5 rounded-full hover:bg-white/20 disabled:opacity-50 disabled:hover:bg-transparent"
                                      >
                                          <Icon name="plus" className="w-4 h-4 text-[--text-color-light]" />
                                      </button>
                                  </div>
                              )}
                              {cardViewMode === 'list' && (
                                  <>
                                      <div className="w-px h-6 bg-[--glass-border] mx-1"></div>
                                      <button 
                                          onClick={() => setCardListDensityIndex(i => (i + 1) % LIST_DENSITY_OPTIONS.length)} 
                                          className="p-2 rounded-full transition-colors hover:bg-white/10 flex items-center gap-2"
                                          aria-label="Toggle list density"
                                      >
                                          <Icon name="chevrons-up-down" className="w-5 h-5" />
                                          <span className="text-xs font-bold w-20 text-left">{LIST_DENSITY_OPTIONS[cardListDensityIndex].name}</span>
                                      </button>
                                  </>
                              )}
                          </div>
                      </div>

                      {cardViewMode === 'grid' ? (
                          <div className="grid gap-6" style={{ gridTemplateColumns: `repeat(auto-fill, minmax(${GRID_SIZE_STEPS[cardGridSizeIndex]}px, 1fr))` }}>
                              {filteredCards?.map((card, index) => (
                                  <div key={card.id} className="group relative" draggable onDragStart={(e) => handleDragStart(e, 'card', card.id)} onDrop={(e) => handleDrop(e, 'card', card.id)} onDragOver={handleDragOver} onDragEnd={handleDragEnd}>
                                       <div className="glass-card rounded-2xl p-5 min-h-[180px] flex flex-col gap-2 transition-transform duration-200 group-hover:scale-[1.03] relative">
                                          <div className="absolute top-3 left-3 bg-[--accent-color] text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center z-10 select-none">
                                              {index + 1}
                                          </div>
                                          <div className="flex-1">
                                              <p className="text-xs font-bold uppercase text-[--text-color-light] opacity-50 mb-1 text-center">Front</p>
                                              {card.front_image_url && <img src={card.front_image_url} className="max-h-24 object-contain rounded-md mx-auto mb-2" />}
                                              <div className="prose text-[--text-color] max-w-full text-center" dangerouslySetInnerHTML={renderMarkdown(card.front)}></div>
                                          </div>
                                          <div className="h-px w-full bg-gradient-to-r from-transparent via-[--glass-border] to-transparent my-1"></div>
                                          <div className="flex-1">
                                              <p className="text-xs font-bold uppercase text-[--text-color-light] opacity-50 mb-1 text-center">Back</p>
                                              {card.back_image_url && <img src={card.back_image_url} className="max-h-24 object-contain rounded-md mx-auto mb-2" />}
                                              <div className="prose text-[--text-color-light] max-w-full text-center" dangerouslySetInnerHTML={renderMarkdown(card.back)}></div>
                                          </div>
                                      </div>
                                      <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                          <Icon name="grip-vertical" className="w-5 h-5 cursor-move text-[--text-color-light]" />
                                          <button onClick={() => setModal({ type: 'editCard', data: card })} className="p-2 bg-white/20 rounded-full hover:bg-white/40"><Icon name="edit" className="w-4 h-4"/></button>
                                          <button onClick={() => setModal({ type: 'deleteCard', data: card })} className="p-2 bg-white/20 rounded-full hover:bg-white/40"><Icon name="trash" className="w-4 h-4"/></button>
                                      </div>
                                  </div>
                              ))}
                              <button onClick={() => setModal({ type: 'addCard' })} className="border-2 border-dashed border-[--text-color-light]/50 rounded-2xl flex flex-col items-center justify-center min-h-[180px] hover:border-[--text-color] hover:text-[--text-color] text-[--text-color-light] transition-all duration-300 hover:bg-white/10">
                                  <Icon name="plus" className="w-10 h-10"/>
                                  <span className="mt-2 font-semibold">New Card</span>
                              </button>
                          </div>
                      ) : (
                           <div className="space-y-3">
                              {filteredCards?.map((card, index) => {
                                  const { padding, prose } = LIST_DENSITY_OPTIONS[cardListDensityIndex];
                                  return (
                                      <div key={card.id} className={`group relative glass-card rounded-2xl ${padding} flex items-center gap-4`} draggable onDragStart={(e) => handleDragStart(e, 'card', card.id)} onDrop={(e) => handleDrop(e, 'card', card.id)} onDragOver={handleDragOver} onDragEnd={handleDragEnd}>
                                          <div className="flex items-center gap-3 text-[--text-color-light] flex-shrink-0">
                                              <span className="font-semibold text-base w-6 text-right select-none">{index + 1}</span>
                                              <Icon name="grip-vertical" className="w-5 h-5 cursor-move" />
                                          </div>
                                          <div className="grid grid-cols-2 gap-4 flex-grow">
                                              <div className={`prose ${prose} text-[--text-color] max-w-full`} dangerouslySetInnerHTML={renderMarkdown(card.front)}></div>
                                              <div className={`prose ${prose} text-[--text-color-light] max-w-full`} dangerouslySetInnerHTML={renderMarkdown(card.back)}></div>
                                          </div>
                                          <div className="flex gap-1">
                                              <button onClick={() => setModal({ type: 'editCard', data: card })} className="p-2 bg-white/20 rounded-full hover:bg-white/40 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="edit" className="w-4 h-4"/></button>
                                              <button onClick={() => setModal({ type: 'deleteCard', data: card })} className="p-2 bg-white/20 rounded-full hover:bg-white/40 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash" className="w-4 h-4"/></button>
                                          </div>
                                      </div>
                                  )
                              })}
                               <button onClick={() => setModal({ type: 'addCard' })} className="w-full border-2 border-dashed border-[--text-color-light]/50 rounded-2xl flex items-center justify-center p-4 hover:border-[--text-color] hover:text-[--text-color] text-[--text-color-light] transition-all duration-300 hover:bg-white/10">
                                  <Icon name="plus" className="w-6 h-6"/>
                                  <span className="ml-2 font-semibold">New Card</span>
                              </button>
                           </div>
                      )}
                  </>
              );
              case 'folders': 
              default: return (
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                      {filteredFolders.map(folder => (
                          <div key={folder.id} className="group relative" draggable onDragStart={(e) => handleDragStart(e, 'folder', folder.id)} onDrop={(e) => handleDrop(e, 'folder', folder.id)} onDragOver={handleDragOver} onDragEnd={handleDragEnd}>
                              <div onClick={() => navigateTo('decks', folder)} className="glass-card rounded-2xl p-6 h-48 flex flex-col justify-between cursor-pointer transition-transform hover:scale-105">
                                  <Icon name="folder" className="w-10 h-10"/>
                                  <h3 className="text-xl font-bold mt-auto truncate">{folder.name}</h3>
                                  <p className="text-[--text-color-light]">{folder.decks.length} decks</p>
                              </div>
                              <div className="absolute top-2 right-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                  <Icon name="grip-vertical" className="w-5 h-5 cursor-move text-[--text-color-light]" />
                                  <button onClick={(e) => { e.stopPropagation(); setModal({ type: 'editFolder', data: folder }); }} className="p-2 bg-white/20 rounded-full hover:bg-white/40"><Icon name="edit" className="w-4 h-4"/></button>
                                  <button onClick={(e) => { e.stopPropagation(); setModal({ type: 'deleteFolder', data: folder }); }} className="p-2 bg-white/20 rounded-full hover:bg-white/40"><Icon name="trash" className="w-4 h-4"/></button>
                              </div>
                          </div>
                      ))}
                      <button onClick={() => setModal({ type: 'addFolder'})} className="border-2 border-dashed border-[--text-color-light]/50 rounded-2xl flex flex-col items-center justify-center h-48 hover:border-[--text-color] hover:text-[--text-color] text-[--text-color-light] transition-all duration-300 hover:bg-white/10">
                          <Icon name="plus" className="w-10 h-10"/>
                          <span className="mt-2 font-semibold">New Folder</span>
                      </button>
                  </div>
              );
          }
        }
        
        const SettingsContent = () => {
          const defaultThemeColors = {
              bgGradientStart: '#fdfbfb', bgGradientEnd: '#ebedee', textColor: '#1f2937', textColorLight: '#6b7280',
              glassBg: 'rgba(255, 255, 255, 0.2)', glassBorder: 'rgba(255, 255, 255, 0.3)',
              shadowColor: 'rgba(0, 0, 0, 0.1)', accentColor: '#8b5cf6',
          };
          const [editingTheme, setEditingTheme] = useState(null);

          const handleStartEditing = (theme) => {
              if(theme) {
                  setEditingTheme(theme);
              } else {
                  setEditingTheme({
                      id: `custom-${Date.now()}`,
                      name: 'My New Theme',
                      colors: defaultThemeColors,
                  })
              }
          }

          const handleFormChange = (e) => {
              if (!editingTheme) return;
              const { name, value } = e.target;
              if (name === 'name') {
                  setEditingTheme({ ...editingTheme, name: value });
              } else {
                  setEditingTheme({ ...editingTheme, colors: { ...editingTheme.colors, [name]: value } });
              }
          }

          const handleSaveAndApply = () => {
              if (editingTheme) {
                  handleCustomThemeSave(editingTheme);
              }
          }
          
          const handleDelete = () => {
              if(editingTheme) {
                  handleCustomThemeDelete(editingTheme.id);
                  setEditingTheme(null);
              }
          }

          const ColorInput = ({label, name, value}) => (
              <div className="flex items-center justify-between">
                  <label className="text-sm">{label}</label>
                  <input type="color" name={name} value={value} onChange={handleFormChange} className="w-8 h-8 p-0 border-none rounded cursor-pointer bg-transparent" />
              </div>
          )
          
          const allThemes = [...presetThemes, ...customThemes];
          const currentThemeId = typeof activeTheme === 'string' ? activeTheme : activeTheme.id;

          return (
              <div>
                  <h3 className="font-bold text-lg mb-2">Appearance</h3>
                  <p className="text-sm text-[--text-color-light] mb-4">Select a preset theme or create your own.</p>
                  <div className="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-6">
                      {allThemes.map(theme => {
                          const isPreset = 'class' in theme;
                          const isActive = currentThemeId === theme.id;
                          return (
                              <div key={theme.id} className="relative group">
                                   <button onClick={() => setActiveTheme(isPreset ? theme.id : theme)} className={`w-full aspect-square rounded-lg flex items-center justify-center text-center p-2 border-2 transition-all ${isActive ? 'border-[--accent-color]' : 'border-transparent hover:border-white/50'}`}>
                                      <div className={`w-full h-full rounded-md ${isPreset ? theme.class : ''}`} style={!isPreset ? { background: `linear-gradient(135deg, ${theme.colors.bgGradientStart}, ${theme.colors.bgGradientEnd})`} : {}}></div>
                                   </button>
                                   <p className="text-xs text-center mt-1 truncate">{theme.name}</p>
                                  {!isPreset && (
                                      <button onClick={() => handleStartEditing(theme)} className="absolute top-1 right-1 p-1 bg-black/30 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                          <Icon name="edit" className="w-3 h-3 text-white"/>
                                      </button>
                                  )}
                              </div>
                          )
                      })}
                       <button onClick={() => handleStartEditing()} className="w-full aspect-square rounded-lg flex flex-col items-center justify-center border-2 border-dashed border-[--text-color-light]/50 hover:border-[--text-color] transition-colors">
                          <Icon name="plus" className="w-8 h-8 text-[--text-color-light]"/>
                          <span className="text-xs mt-1">Create</span>
                      </button>
                  </div>

                  {editingTheme && (
                      <div className="p-4 rounded-lg bg-white/10 mt-4 animate-fadeIn">
                          <h4 className="font-bold mb-3">{editingTheme.id.startsWith('custom-') ? 'Create New Theme' : 'Edit Theme'}</h4>
                          <FormInput id="name" label="Theme Name" name="name" value={editingTheme.name} onChange={handleFormChange} />
                          <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                              <ColorInput label="Gradient Start" name="bgGradientStart" value={editingTheme.colors.bgGradientStart} />
                              <ColorInput label="Gradient End" name="bgGradientEnd" value={editingTheme.colors.bgGradientEnd} />
                              <ColorInput label="Text" name="textColor" value={editingTheme.colors.textColor} />
                              <ColorInput label="Text Light" name="textColorLight" value={editingTheme.colors.textColorLight} />
                              <ColorInput label="Accent" name="accentColor" value={editingTheme.colors.accentColor} />
                          </div>
                           <div className="flex justify-between items-center mt-4">
                              <div>
                               {!editingTheme.id.startsWith('custom-') && <button onClick={handleDelete} className="text-red-400 text-sm font-semibold hover:underline">Delete</button>}
                              </div>
                              <div className="flex gap-2">
                                  <CuteButton onClick={() => setEditingTheme(null)} className="!py-1 !px-3 !from-white/20 !to-white/10">Cancel</CuteButton>
                                  <CuteButton onClick={handleSaveAndApply} className="!py-1 !px-3">Save & Apply</CuteButton>
                              </div>
                          </div>
                      </div>
                  )}
              </div>
          )
        }

        const renderModalContent = () => {
          switch(modal.type) {
            case 'addFolder': case 'editFolder': return (
              <form onSubmit={(e) => { e.preventDefault(); handleAddEditFolder(e.currentTarget.folderName.value); }}>
                <FormInput id="folderName" label="Folder Name" name="folderName" type="text" defaultValue={modal.data?.name || ''} required autoFocus/>
                <CuteButton type="submit" className="w-full py-3 mt-2">{modal.type === 'editFolder' ? 'Save Changes' : 'Create Folder'}</CuteButton>
              </form>
            );
            case 'deleteFolder': return (
              <div>
                <p className="mb-4">Are you sure you want to delete the folder "{modal.data?.name}" and all its contents?</p>
                <div className="flex justify-end gap-2">
                  <CuteButton onClick={() => setModal({type: null})}>Cancel</CuteButton>
                  <CuteButton onClick={() => handleDeleteFolder(modal.data?.id)} className="!bg-red-500/50 !from-red-500/50 !to-red-500/30 text-white">Delete</CuteButton>
                </div>
              </div>
            );
            case 'addDeck': case 'editDeck': return (
              <form onSubmit={(e) => { e.preventDefault(); handleAddEditDeck(e.currentTarget.deckName.value); }}>
                <FormInput id="deckName" label="Deck Name" name="deckName" type="text" defaultValue={modal.data?.name || ''} required autoFocus/>
                <CuteButton type="submit" className="w-full py-3 mt-2">{modal.type === 'editDeck' ? 'Save Changes' : 'Create Deck'}</CuteButton>
              </form>
            );
            case 'deleteDeck': return (
              <div>
                <p className="mb-4">Are you sure you want to delete the deck "{modal.data?.name}"?</p>
                <div className="flex justify-end gap-2">
                  <CuteButton onClick={() => setModal({type: null})}>Cancel</CuteButton>
                  <CuteButton onClick={() => handleDeleteDeck(modal.data?.id)} className="!bg-red-500/50 !from-red-500/50 !to-red-500/30 text-white">Delete</CuteButton>
                </div>
              </div>
            );
            case 'addCard': case 'editCard': return <AddEditCardForm />;
            case 'deleteCard': return (
              <div>
                <p className="mb-4">Are you sure you want to delete this card?</p>
                <div className="flex justify-end gap-2">
                  <CuteButton onClick={() => setModal({type: null})}>Cancel</CuteButton>
                  <CuteButton onClick={() => handleDeleteCard(modal.data?.id)} className="!bg-red-500/50 !from-red-500/50 !to-red-500/30 text-white">Delete</CuteButton>
                </div>
              </div>
            );
            case 'importCards': return <ImportCardsForm onImport={handleBulkAddCards} />;
            case 'settings': return <SettingsContent />;
            default: return null;
          }
        }

        const sortOptions = [
          { value: 'custom', label: 'Custom Order' },
          { value: 'name_asc', label: 'Name (A-Z)' },
          { value: 'name_desc', label: 'Name (Z-A)' },
          { value: 'date_desc', label: 'Newest First' },
          { value: 'date_asc', label: 'Oldest First' },
        ];

        if (loading && !session) return <div></div>;
        if (!session) return <AuthScreen />;

        return (
          <div className="min-h-screen w-full">
            <Header />
            <main className="p-4 sm:p-6 w-full max-w-7xl mx-auto">
              <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
                <Breadcrumbs />
                 <div className="flex items-center gap-4">
                      <div className="relative">
                          <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[--text-color-light]"/>
                          <input 
                              type="text" 
                              placeholder="Search..."
                              value={searchTerm}
                              onChange={(e) => setSearchTerm(e.target.value)}
                              className="pl-10 pr-4 py-2 w-full sm:w-48 bg-white/10 border border-white/20 rounded-full focus:ring-2 focus:ring-[--accent-color] focus:outline-none"
                          />
                      </div>
                       <Dropdown
                          options={sortOptions}
                          value={sortOption}
                          onChange={(val) => setSortOption(val)}
                          className="w-48"
                        />
                  </div>
              </div>
              
              {renderContent()}
            </main>
            
            <Modal 
              isOpen={modal.type !== null} 
              onClose={() => setModal({ type: null })}
              title={
                  modal.type?.includes('add') ? `Create New ${modal.type.includes('Folder') ? 'Folder' : modal.type.includes('Deck') ? 'Deck' : 'Card'}` : 
                  modal.type?.includes('edit') ? `Edit ${modal.type.includes('Folder') ? 'Folder' : modal.type.includes('Deck') ? 'Deck' : 'Card'}` :
                  modal.type?.includes('delete') ? 'Confirm Deletion' : 
                  modal.type === 'settings' ? 'Settings' :
                  modal.type === 'importCards' ? 'Import Cards' : ''
              }
             >
              {renderModalContent()}
             </Modal>
             
             <StudyModal 
                  isOpen={studyModalOpen}
                  onClose={() => setStudyModalOpen(false)}
                  deckName={activeDeck?.name || ''}
                  cards={activeDeck?.cards || []}
             />
          </div>
        );
      }
      
      // --- From index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>